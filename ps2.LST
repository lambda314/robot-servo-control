C51 COMPILER V9.01   PS2                                                                   11/19/2016 22:07:33 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE PS2
OBJECT MODULE PLACED IN ps2.OBJ
COMPILER INVOKED BY: d:\C51\BIN\C51.EXE ps2.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "ps2.h"
   2          
   3          uchar  HAND;                       
   4          uchar  xdata RES[6]; 
   5          uchar  keybuf0;                                 //手柄按键编码存储单元
   6          uchar  keybuf1;
   7          
   8          uint t;   
   9          /**********************************************<+><+><+><+><+>★【robot】★<+><+><+><+><+>****************
             -********************************
  10          函数名称：delay
  11          函数功能：用于PS2手柄短暂的延时
  12          输入参数：uchar k
  13          输出参数：无
  14          ***********************************************<<<<<<<<<<<<<<<★【robot】★>>>>>>>>>>>>>>>****************
             -********************************/
  15          void delay(uchar k)          
  16          {
  17   1         uchar i;
  18   1         for(i=0;i<k;i++);
  19   1      }
  20          /**********************************************<+><+><+><+><+>★【robot】★<+><+><+><+><+>****************
             -********************************
  21          函数名称：ps2_out
  22          函数功能：PS2发送信号
  23          输入参数：无
  24          输出参数：无
  25          ***********************************************<<<<<<<<<<<<<<<★【robot】★>>>>>>>>>>>>>>>****************
             -********************************/
  26          void ps2_out(void)                              //主机接收子程序            
  27          {
  28   1          int j,k;
  29   1          unsigned char duf=0;
  30   1          j=1;
  31   1          for(k=0;k<=7;k++)       //逐位发送 
  32   1          {
  33   2             CLK=1;
  34   2             delay(5);
  35   2             CLK=0;
  36   2             delay(5);
  37   2             if(DAT==1)
  38   2                duf=duf+j;
  39   2             j=j*2;
  40   2             CLK=1;
  41   2             delay(5);
  42   2          }
  43   1          RES[t++]=duf;
  44   1      }
  45          /**********************************************<+><+><+><+><+>★【robot】★<+><+><+><+><+>****************
             -********************************
  46          函数名称：ps2_inout
  47          函数功能：PS2手柄接受信号
  48          输入参数：无
  49          输出参数：无
  50          ***********************************************<<<<<<<<<<<<<<<★【robot】★>>>>>>>>>>>>>>>****************
C51 COMPILER V9.01   PS2                                                                   11/19/2016 22:07:33 PAGE 2   

             -********************************/ 
  51          void ps2_inout(void)                    //手柄发送子程序
  52          {
  53   1          uchar buf,duf=0;
  54   1          uchar i,j=1;
  55   1          buf=HAND;
  56   1          for(i=0;i<=7;i++)   //逐位接收     
  57   1          {
  58   2           CLK=1;
  59   2           delay(5);
  60   2           if(buf&0x01)
  61   2              CMND=1;
  62   2           else
  63   2              CMND=0;
  64   2           buf=buf>>1;
  65   2           CLK=0;
  66   2           delay(5);
  67   2           if(DAT==1)
  68   2              duf=duf+j;
  69   2           j=j*2;
  70   2           CLK=1;
  71   2           delay(5);
  72   2          }
  73   1          RES[t++]=duf;
  74   1              if(t==6)
  75   1              t=0;
  76   1      }
  77          /**********************************************<+><+><+><+><+>★【robot】★<+><+><+><+><+>****************
             -********************************
  78          函数名称：key_scan
  79          函数功能：PS2按键扫描
  80          输入参数：无
  81          输出参数：无
  82          ***********************************************<<<<<<<<<<<<<<<★【robot】★>>>>>>>>>>>>>>>****************
             -********************************/ 
  83          void key_scan(void)     
  84          {
  85   1              
  86   1          t=0;
  87   1          ATT=0;         //主机读手柄先拉低ATT
  88   1          HAND=0x01;     //主机发送开始命令
  89   1          ps2_inout();     //0xff
  90   1          delay(5);
  91   1          HAND=0x42;     //主机发送请求数据命令
  92   1          ps2_inout();     //0x41：手柄返回请求应答信号
  93   1          delay(25);
  94   1          ps2_out();       //0x5A
  95   1          delay(25);
  96   1          ps2_out();     //keybuf0(空0xff)  //手柄返回按键编码第一字节
  97   1          delay(25);
  98   1          ps2_out();       //keybuf1(空0xff)  //手柄返回按键编码第二字节
  99   1          keybuf0=RES[3];              
 100   1          keybuf1=RES[4];
 101   1          delay(10);
 102   1          ATT=1;
 103   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    218    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      6    ----
C51 COMPILER V9.01   PS2                                                                   11/19/2016 22:07:33 PAGE 3   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =      5    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
